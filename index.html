<!DOCTYPE html>
    <head>
        <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
        <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="saveSvgAsPng.js"></script> <!--- From: https://github.com/exupero/saveSvgAsPng -->
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
                display: flex;
                flex-direction: row;
                justify-content: center;
                background-color:lightgray;
            }
            #wrapper {
                width: 1000px;
                background-color: white;
                padding: 30px;
            }
            #container, #output-container {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }
            #input-buttons {
                margin-top: 10px;
                display: flex;
                flex-direction: row;
            }
            button {
                flex-grow: 1;
                margin: 2px;
                font-size: 1em;
                color: white;
                background-color: #5599EE;
            }
            #controls {
                display: flex;
                flex-direction: column;
            }
            #data-wrapper {
                padding: 0;
                border: 1px solid darkgray;
                width: 500px;
                height: 300px;
                overflow: auto;
            }
            #input-container {
                margin: 0;
            }
            #input-data {
                margin: 0;
                border: 1px solid darkgray;
                padding: 0;
                width: 500px;
                height: 100px;
                white-space: nowrap;
                overflow: auto;
                resize: none;
            }
            #input-table, th {
                margin: 0;
                border: 1px solid darkgray;
                border-collapse: collapse;
            }
            th, td {
                padding-left: 10px;
                padding-right: 10px;
            }

            #input-table {
                width: 500px;
            }

            #oppscores-table {
                width:auto;
                border: 1px solid black;
                border-collapse: collapse;
                margin-top: 10px;
            }
            #oppscores-table th {
                border: 1px solid black;
            }
            td {
                font-family: monospace;
            }
            .important {
                font-style: italic;
            }
            #footer {
                width: 100%;
                margin-top: 20px;
                text-align: right;
            }
            .big-red {
                font-size: 2em;
                color: red;
                padding-top: -5px;
                padding-bottom: -5px;
            }
            .hidden-button {
                visibility: hidden;
            }
            .ext-info {
                font-style: italic;
            }
            #status {
                color: red;
            }
        </style>
    </head>
    <body>
        <div id="wrapper">
            <h2>Opportunity Score and Map</h2>
            Import a CSV file or paste tab- or comma-separated data formatted in <span class="important">3 columns (<b>Outcome, Importance, Satisfaction</b>)</span>, as indicated below, then click on [Map data].
            <br /><br />
            Sample data has been included for you to play around with. Click [Clear data] to enter your own data.
            <br /><br />
            <span class="ext-info">(For more information about the Opportunity Score and Map, check <a href="https://medium.com/uxr-microsoft/what-is-the-opportunity-score-and-how-to-obtain-it-bb81fcbf79b7" target="_blank">this blog post</a>.)</span>
            <br />
            <br />
            <h3>Input data</h3>
            <div id="container">
                <div id="controls">
                    <input type="file" id="file-selector" accept=".csv" single />
                    <p id="status"> </p>
                    <div id="input-container">
                        <table id="input-table">
                            <tr>
                                <th>Outcome</th>
                                <th>Importance</th>
                                <th>Satisfaction</th>
                            </tr>
                        </table>
    
                        <textarea id="input-data" placeholder="Paste tab or comma-separated data here"></textarea>
                    </div>
                    <div id="input-buttons">
                        <button id="refresh">Map data</button>
                        <button id="clear">Clear data</button>
                    </div>
                </div>

            </div>
            <div id="output-container">
                <div>
                    <h3>Opportunity Map/Landscape</h3>
                    <button id="export-map" class="hidden-button">Export map to PNG</button>
                    <div id="map-area"></div>
                </div>
                <div>
                    <h3>Opportunity Scores</h3>
                    <button id="export-table" class="hidden-button">Copy scores to clipboard</button>
                    <table id="oppscores-table">
                        <tr>
                            <th class="big-red">â€¢</th>
                            <th>Outcome</th>
                            <th>Importance</th>
                            <th>Satisfaction</th>
                            <th>OppScore</th>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="footer">
                <a href="https://jpcarrascal.github.io" target="_blank">jpcarrascal.github.io</a>
            </div>
        </div>
        <script>
            window.onload = function() {
                var removeMissing = true;
                if (window.location.search.substr("keepMissing")) {
                    console.log("Rows with missing values will not be removed")
                    removeMissing = false;
                }
                function refresh(data) {
                    // set the dimensions and margins of the graph
                    var margin = {top: 10, right: 10, bottom: 50, left: 50},
                        width = 520 - margin.left - margin.right,
                        height = 470 - margin.top - margin.bottom;
                    
                    // append the svg object to the body of the page
                    var SVG = d3.select("#map-area")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform",
                                "translate(" + margin.left + "," + margin.top + ")");

                    
                    // X scale and Axis
                    var x = d3.scaleLinear()
                        .domain([0, 10])         // This is the min and the max of the data: 0 to 100 if percentages
                        .range([0, width]);       // This is the corresponding value I want in Pixel
                    SVG
                        .append('g')
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));
                    
                    // X scale and Axis
                    var y = d3.scaleLinear()
                        .domain([0, 10])         // This is the min and the max of the data: 0 to 100 if percentages
                        .range([height, 0]);       // This is the corresponding value I want in Pixel
                    SVG
                        .append('g')
                        .call(d3.axisLeft(y));

                    SVG.append("line")
                        .attr("x1", x(10))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "black");
                    
                    SVG.append("line")
                        .attr("x1", x(0))
                        .attr("y1", y(10))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "black");

                    SVG.append("line")
                        .attr("x1", x(0))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "lightgrey");
                    
                    SVG.append("line")
                        .attr("x1", x(5))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "lightgrey");
                    
                    SVG.append("text")     
                        .attr("x", function (d) { return x(3); } )
                        .attr("y", function (d) { return y(6); } )
                        .style("text-anchor", "middle")
                        .text("Overserved")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(4); } )
                        .attr("y", function (d) { return y(2); } )
                        .style("text-anchor", "middle")
                        .text("Appropriately Served")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(8); } )
                        .attr("y", function (d) { return y(2); } )
                        .style("text-anchor", "middle")
                        .text("Underserved")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "lightgrey");
                    // Axis labels
                    SVG.append("text")     
                        .attr("x", function (d) { return x(-5); } )
                        .attr("y", function (d) { return y(10.6); } )
                        .style("text-anchor", "middle")
                        .text("Satisfaction")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "grey")
                        .attr("transform", function(d) {
                                return "rotate(-90)" 
                        });

                    SVG.append("text")     
                        .attr("x", function (d) { return x(5); } )
                        .attr("y", function (d) { return y(-0.8); } )
                        .style("text-anchor", "middle")
                        .text("Importance")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "grey");

                    // points:
                    var points = SVG
                        .selectAll("whatever")
                        .data(data)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d){ return x(d.x) })
                        .attr("cy", function(d){ return y(d.y) })
                        .style("fill", "red")
                        .attr("r", 5)

                    var labels = SVG
                        .selectAll("whatever")
                        .data(data)
                        .enter()
                        .append("text")
                        .attr("x", function (d) { return x(d.x)-8; } )
                        .attr("y", function (d) { return y(d.y)+3; } )
                        .text(function(d) { return d.index; })
                        .attr("font-family", "sans-serif")
                        .style("text-anchor", "end")
                        .attr("font-size", "12px")
                        .attr("cursor","default")
                        .attr("fill", "#666")

                }
                refresh([]);
                //generateRandomData();
                readSampleData();

                d3.select("#refresh").on('click', function(e){
                    //d3.selectAll("SVG > *").remove();
                    //document.querySelector("#input-data").value = "";
                    d3.select("#table-body").remove();
                    var inputdata = document.querySelector("#input-data").value;
                    var newData = parseData(inputdata);
                    if (newData.length > 0) {
                        document.querySelectorAll(".hidden-button").forEach( elem => { elem.style.visibility = "visible" });
                        // TODO: clear input file
                        var oppScoreData = calculateOppScores(newData);
                        if (d3.select("svg")) d3.select("svg").remove();
                        asTable(oppScoreData);
                        refresh(oppScoreData);   
                    }
                });

                d3.select("#export-map").on('click', function(e){
                    saveSvgAsPng(document.querySelector("svg"), "OppMap.png");
                });

                d3.select("#export-table").on('click', function(e){
                    console.log(document.querySelector("Not yet implemented"));
                    var tableElement = document.querySelector("#oppscores-table");
                    selectElementContents(tableElement);
                    document.execCommand('copy');
                    document.querySelector("#export-table").innerText = "Copied!";
                    setTimeout(() => {document.querySelector("#export-table").innerText = "Copy scores to clipboard"}, 3000);
                });

                function clearData() {
                    d3.select("svg").remove();
                    d3.select("#table-body").remove();
                    document.querySelector("#input-data").value = "";
                    document.querySelector("#input-data").style.display = "block";
                    document.querySelectorAll(".hidden-button").forEach( elem => { elem.style.visibility = "hidden" });
                    refresh([]);
                }

                d3.select("#clear").on('click', function(e){
                    clearData();
                });

                // Load sample data
                function readSampleData() {
                    var result = Array();
                    d3.csv("https://raw.githubusercontent.com/jpcarrascal/OppScoreWeb/main/sampledata.csv", function(data) {
                        for (var i = 0; i < data.length; i++) {
                            result[i] = {outcome: data[i].outcome, x: data[i].importance, y: data[i].satisfaction}
                            document.querySelector("#input-data").value += (result[i].outcome + "\t"
                                                        + result[i].x + "\t" + result[i].y + "\n");
                        }
                        console.log("Read "+i+" rows");
                    });
                    return result;
                }

                // Read CSV file (borrowed from https://web.dev/read-files/)
                const status = document.getElementById('status');
                if (window.FileList && window.File && window.FileReader) {
                    document.getElementById('file-selector').addEventListener('change', event => {
                        clearData();
                        status.textContent = '';
                        const file = event.target.files[0];
                        if (!file.type) {
                            status.textContent = 'Error: The File.type property does not appear to be supported on this browser.';
                            return;
                        }
                        /*
                        if (!file.type.match('text/csv')) {
                            status.textContent = 'Error: The selected file does not appear to be a CSV file.'
                            return;
                        }
                        */
                        const reader = new FileReader();
                        reader.addEventListener('load', event => {
                            parseData(event.target.result);
                        });
                        reader.readAsText(file,"UTF-8");
                    }); 
                }


                function parseData(inputdata) {
                    var newData = Array();
                    var newDisplayData = "";
                    var incompleteRows = 0;
                    var garbageRows = 0;
                    if(inputdata != "") {
                        var lines = inputdata.split(/\n/);
                        var initialDataLength = 0;
                        for(var i = 0; i<lines.length; i++) {
                            if(lines[i] != "") {
                                initialDataLength++;
                                var row = lines[i].split(/[\t,\,]/);
                                row[1] = parseInt(row[1]);
                                row[2] = parseInt(row[2]);
                                if(row.length > 3) {
                                    console.log("Row too long! Removed: " + row);
                                    status.textContent = "Too many columns in CSV file!"
                                    garbageRows++;
                                } else if(row.length == 3 && Number.isInteger(row[1]) && Number.isInteger(row[2]) ) {
                                    newData.push({outcome: row[0], x: row[1], y: row[2]});
                                    newDisplayData += row[0] + "\t" + row[1] + "\t" + row[2] + "\n";
                                } else if ( row.length == 3 && ( !Number.isInteger(row[1]) && !Number.isInteger(row[2]) ) ) {
                                    console.log("Row removed: " + row);
                                    garbageRows++;
                                } else if ( row.length == 3 && ( !Number.isInteger(row[1]) || !Number.isInteger(row[2]) ) ) {
                                    if(removeMissing) { // Remove rows with missing values:
                                        console.log("Row removed: " + row);
                                    } else {
                                        if(isNaN(row[1])) row[1] = "";
                                        if(isNaN(row[2])) row[2] = "";
                                        newData.push({outcome: row[0], x: row[1], y: row[2]});
                                        newDisplayData += row[0] + "\t" + row[1] + "\t" + row[2] + "\n";
                                        console.log("Incomplete row kept: " + row);
                                    }
                                    incompleteRows++;
                                } else {
                                    console.log("Row removed: " + row);
                                    garbageRows++;
                                } 
                            }
                        }
                    }
                    console.log("---");
                    console.log(initialDataLength + " input rows.");
                    console.log(incompleteRows + " missing values found.");
                    console.log(garbageRows + " invalid rows found (e.g. header?).");
                    if(removeMissing) console.log(incompleteRows + " rows removed.");
                    console.log(newData.length + " rows used in calculation.");
                    document.querySelector("#input-data").value = newDisplayData;
                    return newData;
                }

                function calculateOppScores(data) {
                    var outcomes = Array();
                    var OppScores = Array();
                    for(var i = 0; i<data.length; i++)
                        if(!outcomes.includes(data[i].outcome))
                            outcomes.push(data[i].outcome);
                    for(var i = 0; i<outcomes.length; i++) {
                        var thisOutcome = outcomes[i];
                        var sumImp = 0, sumSat = 0, countImp = 0, countSat = 0;
                        for(var j = 0; j<data.length; j++) {
                            var d = data[j];
                            if( d.outcome == thisOutcome ) {
                                if(d.x > 3)
                                    sumImp ++;
                                countImp ++;
                                if(d.y > 3)
                                    sumSat ++;
                                countSat ++;
                            }
                        }

                        //(10* (sum(x>midpoint)/length(x))
                        var meanImp = roundTwo(10 * (sumImp / countImp));
                        var meanSat = roundTwo(10 * (sumSat / countSat));
                        var oppScore = meanImp + (Math.max(meanImp-meanSat,0));
                        oppScore = Math.round((oppScore + Number.EPSILON) * 100) / 100;
                        OppScores.push({ index: 0, outcome: thisOutcome, x: meanImp, y: meanSat, oppScore: oppScore});
                    }

                    OppScores.sort( compare );
                    for(var i=0; i<OppScores.length; i++) {
                        OppScores[i].index = i+1;
                    }

                    return OppScores;
                }

                function asTable(newData) {
                    var table = document.querySelector("#oppscores-table");
                    var tBody = document.createElement('tbody');
                    tBody.id = "table-body";

                    for(var i = 0; i<newData.length; i++) {
                        var row = tBody.insertRow();
                        var c0 = row.insertCell();
                        c0.innerHTML = newData[i].index;
                        var c1 = row.insertCell();
                        c1.innerHTML = newData[i].outcome;
                        var c2 = row.insertCell();
                        c2.innerHTML = newData[i].x;
                        c2.style.textAlign = "right";
                        var c3 = row.insertCell();
                        c3.innerHTML = newData[i].y;
                        c3.style.textAlign = "right";
                        var c4 = row.insertCell();
                        c4.innerHTML = newData[i].oppScore;
                        c4.style.textAlign = "right";
                    }
                    table.append(tBody);
                }

                function generateRandomData() {
                    var result = Array();
                    var N = 8;
                    for(var i=0; i<64; i++) {
                        result[i] = {outcome:"_SampleOutcome_"+(Math.floor(i/N)+1), x: Math.round(Math.random()*4+1), y: Math.round(Math.random()*4+1)};
                        document.querySelector("#input-data").value += (result[i].outcome + "\t"
                                                        + result[i].x + "\t" + result[i].y + "\n");
                    }
                    return result;
                }

                function roundTwo(num) {
                    return Math.round(num * 100) / 100;
                }

                // Quick grab from: https://stackoverflow.com/questions/1129216/sort-array-of-objects-by-string-property-value
                function compare( a, b ) {
                    if ( a.oppScore > b.oppScore ){
                        return -1;
                    }
                    if ( a.oppScore < b.oppScore ){
                        return 1;
                    }
                    return 0;
                }
                // From: https://stackoverflow.com/questions/2044616/select-a-complete-table-with-javascript-to-be-copied-to-clipboard
                function selectElementContents(el) {
                    var body = document.body, range, sel;
                    if (document.createRange && window.getSelection) {
                        range = document.createRange();
                        sel = window.getSelection();
                        sel.removeAllRanges();
                        try {
                            range.selectNodeContents(el);
                            sel.addRange(range);
                        } catch (e) {
                            range.selectNode(el);
                            sel.addRange(range);
                        }
                    } else if (body.createTextRange) {
                        range = body.createTextRange();
                        range.moveToElementText(el);
                        range.select();
                    }
                }

            }
        </script>
    </body>
</html>